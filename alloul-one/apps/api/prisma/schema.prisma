generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PlanTier { FREE PRO BUSINESS ENTERPRISE }
enum UserType { COMPANY INDIVIDUAL }
enum WorkflowRunStatus { PENDING RUNNING SUCCESS FAILED CANCELED }
enum PostVisibility { PUBLIC CONNECTIONS PRIVATE }
enum MarketplaceType { SERVICE JOB REQUEST PRODUCT }
enum NotificationChannel { IN_APP EMAIL WHATSAPP TELEGRAM PUSH }
enum InvoiceStatus { DRAFT OPEN PAID VOID UNCOLLECTIBLE }

model Organization {
  id           String      @id @default(cuid())
  slug         String      @unique
  name         String
  planTier     PlanTier    @default(FREE)
  locale       String      @default("en")
  timezone     String      @default("UTC")
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  teams        Team[]
  users        OrgUser[]
  projects     Project[]
  documents    Document[]
  workflows    Workflow[]
  handovers    Handover[]
  subscriptions Subscription[]
}

model User {
  id            String        @id @default(cuid())
  email         String        @unique
  name          String?
  type          UserType      @default(INDIVIDUAL)
  locale        String        @default("en")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  orgMemberships OrgUser[]
  posts         Post[]
  followsFrom   Follow[]      @relation("follower")
  followsTo     Follow[]      @relation("followee")
}

model OrgUser {
  id            String       @id @default(cuid())
  orgId         String
  userId        String
  roleId        String?
  attributes    Json?
  createdAt     DateTime     @default(now())

  org           Organization @relation(fields: [orgId], references: [id])
  user          User         @relation(fields: [userId], references: [id])
  role          Role?        @relation(fields: [roleId], references: [id])

  @@unique([orgId, userId])
  @@index([orgId])
}

model Role {
  id            String      @id @default(cuid())
  orgId         String?
  key           String
  name          String
  createdAt     DateTime    @default(now())

  permissions   RolePermission[]
  members       OrgUser[]

  @@unique([orgId, key])
}

model Permission {
  id            String      @id @default(cuid())
  key           String      @unique
  description   String?
  roles         RolePermission[]
}

model RolePermission {
  roleId        String
  permissionId  String
  role          Role        @relation(fields: [roleId], references: [id])
  permission    Permission  @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
}

model Team {
  id            String       @id @default(cuid())
  orgId         String
  name          String
  createdAt     DateTime     @default(now())
  org           Organization @relation(fields: [orgId], references: [id])
}

model Document {
  id            String       @id @default(cuid())
  orgId         String
  title         String
  currentVersionId String?
  createdById   String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  org           Organization @relation(fields: [orgId], references: [id])
  versions      DocumentVersion[]
  approvals     DocumentApproval[]

  @@index([orgId])
}

model DocumentVersion {
  id            String      @id @default(cuid())
  documentId    String
  content       Json
  version       Int
  createdById   String
  createdAt     DateTime    @default(now())

  document      Document    @relation(fields: [documentId], references: [id])
  @@unique([documentId, version])
}

model DocumentApproval {
  id            String      @id @default(cuid())
  documentId    String
  approverId    String
  status        String
  createdAt     DateTime    @default(now())

  document      Document    @relation(fields: [documentId], references: [id])
}

model Project {
  id            String       @id @default(cuid())
  orgId         String
  name          String
  description   String?
  status        String
  dueDate       DateTime?
  createdAt     DateTime     @default(now())

  org           Organization @relation(fields: [orgId], references: [id])
  tasks         Task[]

  @@index([orgId, status])
}

model Task {
  id            String      @id @default(cuid())
  orgId         String
  projectId     String
  title         String
  status        String
  priority      String?
  dueDate       DateTime?
  assigneeId    String?
  createdAt     DateTime    @default(now())

  project       Project     @relation(fields: [projectId], references: [id])
  comments      TaskComment[]

  @@index([orgId, projectId, status])
}

model TaskComment {
  id            String      @id @default(cuid())
  taskId        String
  authorId      String
  body          String
  createdAt     DateTime    @default(now())

  task          Task        @relation(fields: [taskId], references: [id])
}

model Workflow {
  id            String      @id @default(cuid())
  orgId         String
  name          String
  definition    Json
  enabled       Boolean     @default(true)
  createdAt     DateTime    @default(now())

  org           Organization @relation(fields: [orgId], references: [id])
  runs          WorkflowRun[]

  @@index([orgId, enabled])
}

model WorkflowRun {
  id            String            @id @default(cuid())
  workflowId    String
  status        WorkflowRunStatus @default(PENDING)
  input         Json?
  output        Json?
  startedAt     DateTime?
  endedAt       DateTime?

  workflow      Workflow          @relation(fields: [workflowId], references: [id])
  logs          WorkflowLog[]
}

model WorkflowLog {
  id            String      @id @default(cuid())
  runId         String
  level         String
  message       String
  createdAt     DateTime    @default(now())

  run           WorkflowRun @relation(fields: [runId], references: [id])
}

model Handover {
  id            String       @id @default(cuid())
  orgId         String
  ownerUserId   String
  status        String
  score         Float?
  report        Json?
  createdAt     DateTime     @default(now())

  org           Organization @relation(fields: [orgId], references: [id])
  checklist     HandoverChecklist[]

  @@index([orgId])
}

model HandoverChecklist {
  id            String      @id @default(cuid())
  handoverId    String
  title         String
  isDone        Boolean     @default(false)

  handover      Handover    @relation(fields: [handoverId], references: [id])
}

model Post {
  id            String         @id @default(cuid())
  authorId      String
  content       String
  visibility    PostVisibility @default(PUBLIC)
  createdAt     DateTime       @default(now())

  author        User           @relation(fields: [authorId], references: [id])
  reactions     Reaction[]
}

model Reaction {
  id            String      @id @default(cuid())
  postId        String
  userId        String
  type          String
  createdAt     DateTime    @default(now())

  post          Post        @relation(fields: [postId], references: [id])
  @@unique([postId, userId, type])
}

model Follow {
  id            String      @id @default(cuid())
  followerId    String
  followeeId    String
  createdAt     DateTime    @default(now())

  follower      User        @relation("follower", fields: [followerId], references: [id])
  followee      User        @relation("followee", fields: [followeeId], references: [id])
  @@unique([followerId, followeeId])
}

model Group {
  id            String      @id @default(cuid())
  name          String
  description   String?
  createdAt     DateTime    @default(now())
}

model MarketplaceListing {
  id            String          @id @default(cuid())
  orgId         String?
  ownerUserId   String
  type          MarketplaceType
  title         String
  description   String
  price         Decimal?        @db.Decimal(12, 2)
  currency      String?         @default("USD")
  createdAt     DateTime        @default(now())
}

model MarketplaceOffer {
  id            String      @id @default(cuid())
  listingId     String
  bidderUserId  String
  amount        Decimal     @db.Decimal(12, 2)
  status        String
  createdAt     DateTime    @default(now())
}

model MarketplaceOrder {
  id            String      @id @default(cuid())
  listingId     String
  buyerUserId   String
  sellerUserId  String
  amount        Decimal     @db.Decimal(12, 2)
  status        String
  createdAt     DateTime    @default(now())
}

model Subscription {
  id            String       @id @default(cuid())
  orgId         String
  tier          PlanTier
  seats         Int          @default(1)
  aiCredits     Int          @default(0)
  startsAt      DateTime
  endsAt        DateTime?

  org           Organization @relation(fields: [orgId], references: [id])
  invoices      Invoice[]
}

model Invoice {
  id            String        @id @default(cuid())
  subscriptionId String
  status        InvoiceStatus @default(DRAFT)
  amount        Decimal       @db.Decimal(12, 2)
  currency      String        @default("USD")
  dueAt         DateTime?
  issuedAt      DateTime      @default(now())

  subscription  Subscription  @relation(fields: [subscriptionId], references: [id])
}

model UsageMeter {
  id            String      @id @default(cuid())
  orgId         String
  key           String
  value         Int         @default(0)
  periodStart   DateTime
  periodEnd     DateTime

  @@index([orgId, key])
}

model Notification {
  id            String              @id @default(cuid())
  orgId         String?
  userId        String
  channel       NotificationChannel
  title         String
  body          String
  readAt        DateTime?
  createdAt     DateTime            @default(now())

  @@index([userId, createdAt])
}

model AuditLog {
  id            String      @id @default(cuid())
  orgId         String?
  actorUserId   String?
  action        String
  resourceType  String
  resourceId    String?
  payload       Json?
  hash          String
  createdAt     DateTime    @default(now())

  @@index([orgId, createdAt])
}

model EventOutbox {
  id            String      @id @default(cuid())
  orgId         String?
  topic         String
  payload       Json
  status        String      @default("PENDING")
  createdAt     DateTime    @default(now())
  processedAt   DateTime?

  @@index([status, createdAt])
}
